---
title: "EDA"
author: "Yinyihong Liu"
date: "2025-02-05"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)  
library(lubridate)  
library(dplyr)
library(zoo)
```

## Load Data

```{r}
# Read the data file
sleep <- read.table("sleep.txt", header = TRUE, sep = "", stringsAsFactors = FALSE)

# Display the first few rows
head(sleep)
```

```{r}
colSums(is.na(sleep))
```


```{r}
# Add default year (e.g., 2025) to the Date column
sleep$Date <- paste("2025", sleep$Date)

# Convert Date to Date object
sleep$Date <- as.Date(sleep$Date, format="%Y %m/%d")

sleep <- sleep %>%
  mutate(
    temp_bed_hour = floor(Bedtime / 100),  # Extract hours
    Bed_min  = Bedtime %% 100,        # Extract minutes
    Bed_hour = (temp_bed_hour + 12) %% 24,  # Adjust to 24-hour format
    Bedtime_time = as.POSIXct(sprintf("%02d:%02d:00", Bed_hour, Bed_min), format="%H:%M:%S")
  )


sleep <- sleep %>%
  mutate(
    Bedtime_time = format(Bedtime_time, "%H:%M:%S")  # Extract only the time part
  )

sleep <- sleep %>%
  select(-temp_bed_hour)  


# Create a new variable for sleep efficiency (as a percentage)
sleep <- sleep %>%
  mutate(SleepEfficiency = TST / TBT * 100)

sleep <- sleep %>%
  mutate(Awake_time = TBT - TTS - TST)

head(sleep)
```
```{r}

filtered_data <- sleep %>% filter(Bed_hour == 23)

filtered_data
```


```{r}
# Adjust Bed_time to make it continuous (e.g., 1:00 AM -> 25, 2:00 AM -> 26)
sleep$Bed_time_continuous <- ifelse(sleep$Bed_hour < 23, sleep$Bed_hour + 24, sleep$Bed_hour) + sleep$Bed_min / 60

# Plot with the new continuous Bed_time
ggplot(sleep, aes(x = Bed_time_continuous)) +
  geom_histogram(binwidth = 0.5, fill = "steelblue", color = "black") +
  scale_x_continuous(breaks = c(22, 23, 24, 25, 26, 27), 
                     labels = c("22:00", "23:00", "0:00", "1:00", "2:00", "3:00"), 
                     limits = c(22, 27)) +
  labs(title = "Distribution of Bedtime", 
       x = "Bedtime (Hour of Day)", 
       y = "Frequency") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 20, face = "bold"),  # Title text size
    axis.title.x = element_text(size = 16),              # X-axis title size
    axis.title.y = element_text(size = 16),              # Y-axis title size
    axis.text.x = element_text(size = 14),               # X-axis tick label size
    axis.text.y = element_text(size = 14)                # Y-axis tick label size
  )

```

## Data -- time he is out of town; no missing values; 

## EDA

```{r}
# 1. Look at the basic structure and summary of the data
str(sleep)
summary(sleep)
```

```{r}
# Count combinations of Cal > 0 and Alc > 0
result <- sleep %>%
  mutate(
    Take_Cal = Cal > 0,
    Drink_Alc = Alc > 0
  ) %>%
  group_by(Take_Cal, Drink_Alc) %>%
  summarise(Count = n(), .groups = "drop")

# View the result
print(result)

```

```{r}
# Correlations among numeric variables
numeric_cols <- c("TTS", "TST", "TBT", "Run", "SleepEfficiency","Awake_time",)
cor_matrix <- cor(sleep[, numeric_cols], use = "complete.obs")
print(cor_matrix)
```



```{r}
# 2. Histograms for key variables

# Histogram of Total Sleep Time (TST)
ggplot(sleep, aes(x = TST)) +
  geom_histogram(binwidth = 30, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Histogram of Total Sleep Time (TST)",
       x = "TST (minutes)",
       y = "Frequency")

# Histogram of Time To Sleep (TTS)
ggplot(sleep, aes(x = TTS)) +
  geom_histogram(binwidth = 5, fill = "green", color = "black", alpha = 0.7) +
  labs(title = "Histogram of Time To Sleep (TTS)",
       x = "TTS (minutes)",
       y = "Frequency")

# Histogram of Total Bed Time (TBT)
ggplot(sleep, aes(x = TBT)) +
  geom_histogram(binwidth = 30, fill = "purple", color = "black", alpha = 0.7) +
  labs(title = "Histogram of Total Bed Time (TBT)",
       x = "TBT (minutes)",
       y = "Frequency")

# Histogram of Sleep Efficiency
ggplot(sleep, aes(x = SleepEfficiency)) +
  geom_histogram(binwidth = 5, fill = "orange", color = "black", alpha = 0.7) +
  labs(title = "Histogram of Sleep Efficiency",
       x = "Sleep Efficiency (%)",
       y = "Frequency")
```

```{r}
# 3. Scatter plot: TST vs TBT
# This addresses the doctor’s hypothesis that actual sleep time (TST) might be nearly fixed regardless 
# of the time in bed (TBT) if the subject is spending more time in bed than necessary.
# so if the human is habitually given much more time in bed, they will just sleep less efficiently
ggplot(sleep, aes(x = TBT, y = SleepEfficiency)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(title = "Scatter Plot of SleepEfficiency vs TBT",
       x = "Total Bed Time (minutes)",
       y = "Sleep Efficiency")
```


```{r}
# 4. Boxplots to compare sleep outcomes by supplement (Cal) and alcohol (Alc) intake.
# add 4combinations
# Boxplot of TTS by Calcium-Magnesium supplement (Cal)
ggplot(sleep, aes(x = factor(Cal), y = TTS)) +
  geom_boxplot(fill = "blue") +
  labs(title = "Time to Sleep by Calcium-Magnesium Supplement",
       x = "Cal (0 = No, 1 = Yes)",
       y = "TTS (minutes)")

# Boxplot of TST by Calcium-Magnesium supplement (Cal)
ggplot(sleep, aes(x = factor(Cal), y = TST)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "Total Sleep Time by Calcium-Magnesium Supplement",
       x = "Cal (0 = No, 1 = Yes)",
       y = "TST (minutes)")

# Boxplot of TTS by Alcohol consumption (Alc)
ggplot(sleep, aes(x = factor(Alc), y = TTS)) +
  geom_boxplot(fill = "blue") +
  labs(title = "Time to Sleep by Alcohol Consumption",
       x = "Alc (0 = No, 1 = Yes)",
       y = "TTS (minutes)")

# Boxplot of TST by Alcohol consumption (Alc)
ggplot(sleep, aes(x = factor(Alc), y = TTS)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "Time to Sleep by Alcohol Consumption",
       x = "Alc (0 = No, 1 = Yes)",
       y = "TTS (minutes)")
```
```{r}
# Add combinations of Cal and Alc to the dataset
sleep <- sleep %>%
  mutate(
    Combination = interaction(factor(Cal), factor(Alc), sep = ", "),
    Combination_Label = case_when(
      Combination == "0, 0" ~ "Cal=0, Alc=0",
      Combination == "0, 1" ~ "Cal=0, Alc=1",
      Combination == "1, 0" ~ "Cal=1, Alc=0",
      Combination == "1, 1" ~ "Cal=1, Alc=1"
    )
  )

# Plot boxplots for TTS across combinations of Cal and Alc
ggplot(sleep, aes(x = Combination_Label, y = TTS, fill = Combination_Label)) +
  geom_boxplot() +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Time to Sleep by Calcium and Alcohol Combinations",
    x = "Combinations (Cal, Alc)",
    y = "TTS (minutes)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title = element_text(size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    legend.position = "none"
  )

```

```{r}
# 5. Scatter plot: Miles run (Run) vs TST
ggplot(sleep, aes(x = Run, y = TST)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "darkgreen") +
  labs(title = "Scatter Plot of Total Sleep Time vs. Miles Run",
       x = "Miles Run",
       y = "TST (minutes)")

# BOXPLOT FOR SLEEP EFFICIENCY
ggplot(sleep, aes(x = Run, y = SleepEfficiency)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "darkgreen") +
  labs(title = "Scatter Plot of SleepEfficiency vs. Miles Run",
       x = "Miles Run",
       y = "SleepEfficiency")
```
```{r}
# Group Run into intervals (0-1, 1-2, etc.)
sleep <- sleep %>%
  mutate(
    Run_group = cut(Run, breaks = seq(0, max(Run, na.rm = TRUE) + 1, by = 1), include.lowest = TRUE)
  )

# TTS by Run_group
p1 <- ggplot(sleep, aes(x = Run_group, y = TTS)) +
  geom_boxplot(fill = "blue", alpha = 0.7) +
  labs(
    title = "Time to Sleep (TTS) by Run Groups",
    x = "Run Group (Miles)",
    y = "TTS (Minutes)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Awake_time by Run_group
p2 <- ggplot(sleep, aes(x = Run_group, y = Awake_time)) +
  geom_boxplot(fill = "green", alpha = 0.7) +
  labs(
    title = "Awake Time by Run Groups",
    x = "Run Group (Miles)",
    y = "Awake Time (Minutes)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# SleepEfficiency by Run_group
p3 <- ggplot(sleep, aes(x = Run_group, y = SleepEfficiency)) +
  geom_boxplot(fill = "purple", alpha = 0.7) +
  labs(
    title = "Sleep Efficiency by Run Groups",
    x = "Run Group (Miles)",
    y = "Sleep Efficiency (Ratio)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# TST by Run_group
p4 <- ggplot(sleep, aes(x = Run_group, y = TST)) +
  geom_boxplot(fill = "orange", alpha = 0.7) +
  labs(
    title = "Total Sleep Time (TST) by Run Groups",
    x = "Run Group (Miles)",
    y = "TST (Minutes)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

```{r}
library(patchwork)

# Combine all plots into a grid
combined_plot <- p1 + p2 + p3 + p4 +
  plot_layout(ncol = 2) +
  plot_annotation(
    title = "Influence of Run on Sleep Metrics (Grouped by Run Intervals)",
    theme = theme(plot.title = element_text(size = 18, face = "bold"))
  )

# Display the combined plot
print(combined_plot)

```
```{r}
# Count data points in each Run_group
run_group_counts <- sleep %>%
  group_by(Run_group) %>%
  summarise(Count = n(), .groups = "drop")

# View the counts
print(run_group_counts)
```


```{r}
# Create a sequence of all dates in the range
full_dates <- seq(min(sleep$Date), max(sleep$Date), by = "day")

# Identify missing dates
missing_dates <- setdiff(full_dates, sleep$Date)
```

```{r}
# Sort the data by date
sleep <- sleep %>%
  arrange(Date)

# Identify gaps between consecutive dates
sleep <- sleep %>%
  mutate(
    Gap = c(0, diff(Date)) > 1,        # Mark if there is a gap
    Segment = cumsum(c(0, diff(Date)) > 1)  # Create a segment ID for continuous periods
  )

ggplot(sleep, aes(x = Date, y = TST)) +
  geom_line(aes(group = Segment), color = "steelblue") +  # Plot continuous segments
  labs(
    title = "Total Sleep Time over Time",
    x = "Date",
    y = "TST (minutes)"
  ) +
  theme_minimal()
```

```{r}
ggplot(sleep, aes(x = Date, y = TTS)) +
  geom_line(aes(group = Segment),color = "steelblue") +
  labs(title = "Time to Sleep over Time",
       x = "Date",
       y = "TTS (minutes)")

ggplot(sleep, aes(x = Date, y = TBT)) +
  geom_line(aes(group = Segment),color = "steelblue") +
  labs(title = "Total Bed Time over Time",
       x = "Date",
       y = "TBT (minutes)")


ggplot(sleep, aes(x = Date, y = SleepEfficiency)) +
  geom_line(aes(group = Segment),color = "steelblue") +
  labs(title = "SleepEfficiency over Time",
       x = "Date",
       y = "SleepEfficiency")

ggplot(sleep, aes(x = Date, y = Awake_time)) +
  geom_line(aes(group = Segment),color = "steelblue") +
  labs(title = "Awake time over Time",
       x = "Date",
       y = "AwakeTime")

```

## Frequentist Modeling
```{r}
# Research Question 1:
# According to the doctor's instructions, the subject should spend (average TST + 30 minutes) in bed.

# Calculate mean and standard deviation of TST
mean_TST <- mean(sleep$TST, na.rm = TRUE)
sd_TST <- sd(sleep$TST, na.rm = TRUE)

# Define the recommended TBT range as (Mean ± 1 SD) + 30 minutes
recommended_TBT_min <- (mean_TST - sd_TST) + 30
recommended_TBT_max <- (mean_TST + sd_TST) + 30

# Print the recommended range
print(paste("Recommended Total Bed Time (TBT) Range:", 
            round(recommended_TBT_min, 1), "to", 
            round(recommended_TBT_max, 1), "minutes"))

# Filter dataset to get Sleep Efficiency values for TBT in this range
filtered_sleep <- sleep %>%
  filter(TBT >= recommended_TBT_min & TBT <= recommended_TBT_max) %>%
  select(TBT, SleepEfficiency)

print(filtered_sleep)

# Compute Average Sleep Efficiency in the Range
avg_sleep_efficiency <- sleep %>%
  filter(TBT >= recommended_TBT_min & TBT <= recommended_TBT_max) %>%
  summarise(mean_SleepEfficiency = mean(SleepEfficiency, na.rm = TRUE))

print(avg_sleep_efficiency)
```

```{r}
plot(x = sleep$TBT, y = sleep$SleepEfficiency, data = sleep)
```


```{r}
# Research Question 2:
# Is the doctor’s hypothesis (that one requires a fixed amount of sleep) reasonable?
model1 <- lm(TST ~ TBT, data = sleep)
summary(model1)
# (If the slope for TBT is near 0, it would support the idea that actual sleep time doesn’t change much with extra time in bed.)
# Plots in EDA part can also contribute to this question
```


```{r}
model2 <- lm(SleepEfficiency ~ TBT, data = sleep)
summary(model2)
```


```{r}
# Research Question 3:
# Do calcium-magnesium supplements affect sleep onset or sleep duration?
# We examine whether taking the supplement (Cal) predicts TTS or TST.
# Model for TTS (falling asleep)
model3 <- lm(TTS ~ Cal + Alc + Run, data = sleep)
summary(model3)
```

```{r}
# Model for TST (staying asleep), controlling for TBT since TBT largely determines the opportunity for sleep.
model4 <- lm(TST ~ TBT + Cal + Alc + Run, data = sleep)
summary(model4)
```

```{r}
# Consider sleep efficiency as an outcome.
model5 <- lm(SleepEfficiency ~ TBT + Cal + Alc + Run, data = sleep)
summary(model5)
```

```{r}
# Research Question 4:
# Do any other factors affect sleep patterns?
model6 <- lm(TTS ~ TBT + Cal + Alc + Run, data = sleep)
summary(model6)
```


```{r}
# Investigate the influence of previous days

# Ensure the data are sorted by Date
sleep <- sleep %>% arrange(Date)

# Create lagged variables and rolling averages for previous day's, previous 3 days, and previous 7 days.
# The lag() function from dplyr creates the previous day’s values.
# The rollmean() function from zoo calculates the rolling (moving) average.
sleep <- sleep %>%
  mutate(
    # Previous day's values
    lag1_TST = lag(TST, 1),
    lag1_TTS = lag(TTS, 1),
    lag1_TBT = lag(TBT, 1),
    lag1_Run = lag(Run, 1),
    
    # Average of previous 3 days
    avg3_TST = rollmean(lag(TST, 1), k = 3, fill = NA, align = "right"),
    avg3_TTS = rollmean(lag(TTS, 1), k = 3, fill = NA, align = "right"),
    avg3_TBT = rollmean(lag(TBT, 1), k = 3, fill = NA, align = "right"),
    avg3_Run = rollmean(lag(Run, 1), k = 3, fill = NA, align = "right"),
    
    # Average of previous 7 days.
    avg7_TST = rollmean(lag(TST, 1), k = 7, fill = NA, align = "right"),
    avg7_TTS = rollmean(lag(TTS, 1), k = 7, fill = NA, align = "right"),
    avg7_TBT = rollmean(lag(TBT, 1), k = 7, fill = NA, align = "right"),
    avg7_Run = rollmean(lag(Run, 1), k = 7, fill = NA, align = "right")
  )

# Because the first few rows will have NA values (since there are not enough previous days),
# we filter out rows with missing lagged/rolling values.
sleep_model <- sleep %>%
  filter(!is.na(lag1_TST),
         !is.na(avg3_TST),
         !is.na(avg7_TST))

head(sleep_model)
```

```{r}
# Model for current day's TST.
# This model uses the previous day's, 3-day average, and 7-day average values of TST, TTS, TBT, and miles_run,
# and also controls for other factors such as Calcium supplement (Cal) and Alcohol (Alc).
model_TST_1 <- lm(TST ~ lag1_TST + 
                    lag1_TTS + 
                    lag1_TBT + 
                    lag1_Run + 
                    Cal + Alc,
                data = sleep_model)
summary(model_TST_1)
```

```{r}
model_TST_3 <- lm(TST ~ avg3_TST + 
                    avg3_TTS + 
                    avg3_TBT + 
                    avg3_Run + 
                    Cal + Alc,
                data = sleep_model)
summary(model_TST_3)
```


```{r}
# Model for current day's TTS.
model_TTS_1 <- lm(TTS ~ lag1_TST  +
                    lag1_TTS  +
                    lag1_TBT +
                    Cal + Alc + Run,
                data = sleep_model)
summary(model_TTS_1)
```

```{r}
model_TTS_3 <- lm(TTS ~ avg3_TST + avg3_TTS + avg3_TBT +
                    Cal + Alc + Run,
                data = sleep_model)
summary(model_TTS_3)
```

```{r}
# Diagnostic Plots for the Models

# For model1 (TST ~ TBT)
par(mfrow = c(2, 2))
plot(model1)

# For model2 (TTS ~ Cal + Alc + Run)
par(mfrow = c(2, 2))
plot(model2)

# For model3
par(mfrow = c(2, 2))
plot(model3)


# For model4
par(mfrow = c(2, 2))
plot(model4)

# For model5
par(mfrow = c(2, 2))
plot(model5)


# For model6
par(mfrow = c(2, 2))
plot(model6)
```

```{r}
# For model_TST_1
par(mfrow = c(2, 2))
plot(model_TST_1)

# For model_TST_3
par(mfrow = c(2, 2))
plot(model_TST_3)

# For model_TTS_1
par(mfrow = c(2, 2))
plot(model_TTS_1)

# For model_TTS_3
par(mfrow = c(2, 2))
plot(model_TTS_3)

# Reset plotting parameters to default (1 plot per page)
par(mfrow = c(1, 1))
```

